{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-6">
    <h1 class="text-2xl font-bold mb-6">{% if farm %}Edit Farm{% else %}Add New Farm{% endif %}</h1>
    
    <form method="post">
        {% csrf_token %}
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Form Fields -->
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="id_name">
                        Farm Name *
                    </label>
                    <input type="text" name="name" id="id_name" required 
                           class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           value="{{ form.name.value|default:'' }}">
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="id_location">
                        Location *
                    </label>
                    <input type="text" name="location" id="id_location" required 
                           class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           value="{{ form.location.value|default:'' }}"
                           placeholder="e.g., Dhaka, Bangladesh">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="id_latitude">
                            Latitude
                        </label>
                        <input type="number" name="latitude" id="id_latitude" step="any"
                               class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               value="{{ form.latitude.value|default:'' }}" readonly>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="id_longitude">
                            Longitude
                        </label>
                        <input type="number" name="longitude" id="id_longitude" step="any"
                               class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               value="{{ form.longitude.value|default:'' }}" readonly>
                    </div>
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="id_area_acres">
                        Area (acres) *
                    </label>
                    <input type="number" name="area_acres" id="id_area_acres" step="0.01" required
                           class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                           value="{{ form.area_acres.value|default:'' }}">
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="id_crop_type">
                        Crop Type *
                    </label>
                    <select name="crop_type" id="id_crop_type" required
                            class="form-select w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="">Select Crop Type</option>
                        <option value="rice" {% if form.crop_type.value == 'rice' %}selected{% endif %}>Rice</option>
                        <option value="wheat" {% if form.crop_type.value == 'wheat' %}selected{% endif %}>Wheat</option>
                        <option value="corn" {% if form.crop_type.value == 'corn' %}selected{% endif %}>Corn</option>
                        <option value="potato" {% if form.crop_type.value == 'potato' %}selected{% endif %}>Potato</option>
                        <option value="tomato" {% if form.crop_type.value == 'tomato' %}selected{% endif %}>Tomato</option>
                        <option value="onion" {% if form.crop_type.value == 'onion' %}selected{% endif %}>Onion</option>
                        <option value="other" {% if form.crop_type.value == 'other' %}selected{% endif %}>Other</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="id_planting_date">
                            Planting Date *
                        </label>
                        <input type="date" name="planting_date" id="id_planting_date" required
                               class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               value="{{ form.planting_date.value|date:'Y-m-d'|default:'' }}">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="id_expected_harvest_date">
                            Expected Harvest *
                        </label>
                        <input type="date" name="expected_harvest_date" id="id_expected_harvest_date" required
                               class="form-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               value="{{ form.expected_harvest_date.value|date:'Y-m-d'|default:'' }}">
                    </div>
                </div>
            </div>

            <!-- Map -->
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">
                        Select Farm Location
                    </label>
                    <div class="relative">
                        <div id="map" class="h-96 w-full border border-gray-300 rounded-md"></div>
                        <div class="absolute top-2 left-2 z-1000 bg-white p-2 rounded shadow">
                            <input type="text" id="search-box" placeholder="Search location..." 
                                   class="px-3 py-1 border border-gray-300 rounded text-sm w-48">
                            <button type="button" id="search-btn" class="ml-1 px-2 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                                Search
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        <i class="fas fa-info-circle"></i>
                        Click on the map to select your farm location, or search for a specific address.
                    </p>
                </div>

                <div class="bg-gray-50 p-4 rounded-md">
                    <h4 class="font-semibold text-gray-700 mb-2">Current Selection:</h4>
                    <div id="selected-location" class="text-sm text-gray-600">
                        No location selected
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-end space-x-3 mt-6">
            <a href="{% url 'farms:farm_list' %}" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                Cancel
            </a>
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                {% if farm %}Update Farm{% else %}Save Farm{% endif %}
            </button>
        </div>
    </form>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css">

<!-- Leaflet JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map centered on Bangladesh
    const map = L.map('map').setView([23.6850, 90.3563], 7);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    let marker = null;
    const selectedLocationDiv = document.getElementById('selected-location');
    const latInput = document.getElementById('id_latitude');
    const lonInput = document.getElementById('id_longitude');
    const searchBox = document.getElementById('search-box');
    const searchBtn = document.getElementById('search-btn');

    // Initialize with existing coordinates if editing
    const existingLat = parseFloat(latInput.value);
    const existingLon = parseFloat(lonInput.value);
    
    if (!isNaN(existingLat) && !isNaN(existingLon)) {
        addMarker(existingLat, existingLon);
        map.setView([existingLat, existingLon], 13);
    }

    // Handle map click
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        addMarker(lat, lng);
        reverseGeocode(lat, lng);
    });

    // Add marker function
    function addMarker(lat, lng) {
        if (marker) {
            map.removeLayer(marker);
        }
        
        marker = L.marker([lat, lng], {
            draggable: true
        }).addTo(map);

        // Update input fields
        latInput.value = lat.toFixed(6);
        lonInput.value = lng.toFixed(6);

        // Handle marker drag
        marker.on('dragend', function(e) {
            const newLat = e.target.getLatLng().lat;
            const newLng = e.target.getLatLng().lng;
            latInput.value = newLat.toFixed(6);
            lonInput.value = newLng.toFixed(6);
            reverseGeocode(newLat, newLng);
        });
    }

    // Reverse geocoding to get address
    function reverseGeocode(lat, lng) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`)
            .then(response => response.json())
            .then(data => {
                if (data && data.display_name) {
                    selectedLocationDiv.innerHTML = `
                        <div class="font-medium text-green-700">Location Selected</div>
                        <div class="text-xs mt-1">${data.display_name}</div>
                        <div class="text-xs mt-1 text-gray-500">
                            Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}
                        </div>
                    `;
                }
            })
            .catch(error => {
                selectedLocationDiv.innerHTML = `
                    <div class="font-medium text-green-700">Location Selected</div>
                    <div class="text-xs mt-1 text-gray-500">
                        Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}
                    </div>
                `;
            });
    }

    // Search functionality
    function searchLocation() {
        const query = searchBox.value.trim();
        if (!query) return;

        searchBtn.textContent = 'Searching...';
        searchBtn.disabled = true;

        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&countrycodes=bd`)
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lng = parseFloat(result.lon);
                    
                    map.setView([lat, lng], 13);
                    addMarker(lat, lng);
                    
                    selectedLocationDiv.innerHTML = `
                        <div class="font-medium text-green-700">Location Found</div>
                        <div class="text-xs mt-1">${result.display_name}</div>
                        <div class="text-xs mt-1 text-gray-500">
                            Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}
                        </div>
                    `;
                } else {
                    alert('Location not found. Please try a different search term.');
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                alert('Search failed. Please try again.');
            })
            .finally(() => {
                searchBtn.textContent = 'Search';
                searchBtn.disabled = false;
            });
    }

    searchBtn.addEventListener('click', searchLocation);
    searchBox.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            searchLocation();
        }
    });

    // Auto-fill location field when address is found
    searchBox.addEventListener('blur', function() {
        if (this.value && !latInput.value) {
            document.getElementById('id_location').value = this.value;
        }
    });
});
</script>

<style>
.form-input, .form-select {
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-input:focus, .form-select:focus {
    border-color: #10b981;
    outline: none;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

#map {
    z-index: 1;
}

.leaflet-control-container .leaflet-top .leaflet-control {
    margin-top: 60px;
}

@media (max-width: 1024px) {
    #map {
        height: 300px;
    }
}
</style>
{% endblock %}